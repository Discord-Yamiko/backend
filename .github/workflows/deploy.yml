name: ðŸ”„ï¸ CI/CD Deploy for Rust Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: ðŸš€ Deploy Rust Backend to VDS
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VDS_HOST }}" >> ~/.ssh/known_hosts

          echo "ðŸ› ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°: SSH Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ"
          ssh -i ~/.ssh/id_rsa root@${{ secrets.VDS_HOST }} "echo 'âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾'"

      - name: ðŸ“‚ Create Project Directory on VDS
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.VDS_HOST }} "mkdir -p /root/${{ github.event.repository.name }}"

      - name: ðŸ“š Copy Files to Server
        run: |
          rsync -avz --delete --exclude '.git' --exclude 'target' . root@${{ secrets.VDS_HOST }}:/root/${{ github.event.repository.name }}/

      - name: ðŸ”» Create ENV File from Secrets
        run: |
          echo "${{ secrets.ENV_FILE }}" > env_content.txt
          scp -i ~/.ssh/id_rsa env_content.txt root@${{ secrets.VDS_HOST }}:/root/${{ github.event.repository.name }}/.env
          rm env_content.txt

      - name: ðŸ¦€ Build and Deploy Rust Project
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.VDS_HOST }} << 'EOF'
            cd /root/${{ github.event.repository.name }}
            echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
            cargo build --release
            echo "ðŸš€ Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
            pm2 restart ${{ github.event.repository.name }} || pm2 start "./target/release/${{ github.event.repository.name }}.exe" --name ${{ github.event.repository.name }}
            echo "ðŸ”¨ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²"
            pm2 save
          EOF
